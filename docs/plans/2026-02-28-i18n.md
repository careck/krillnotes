# i18n Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Add react-i18next UI translation (7 languages), locale-aware date/number formatting, and a language selector in Settings (issue #43).

**Architecture:** react-i18next with statically bundled JSON locale files ‚Äî no runtime fetching. Language preference stored in `AppSettings` on the Rust side, persisted as JSON on disk. i18next initialised synchronously in `src/i18n/index.ts` before React renders. All ~120 UI string keys extracted from 23 components in batches; each batch gets its own commit.

**Tech Stack:** `i18next` ^24, `react-i18next` ^15, Rust `serde` (settings field), Vite (static JSON imports), Tauri v2 `invoke`

**Design doc:** `docs/plans/2026-02-28-i18n-design.md`

---

### Task 0: Create worktree and branch

**Step 1: Create the branch + worktree**

```bash
git -C /Users/careck/Source/Krillnotes worktree add .worktrees/feat/i18n -b feat/i18n
```

All subsequent work happens inside `.worktrees/feat/i18n/`.

---

### Task 1: Install i18next packages

**Files:**
- Modify: `krillnotes-desktop/package.json`

**Step 1: Install packages**

Run from `krillnotes-desktop/`:

```bash
npm install i18next react-i18next
```

**Step 2: Verify install**

```bash
npm ls i18next react-i18next
```

Expected: both listed with no peer-dep warnings.

**Step 3: Commit**

```bash
git add krillnotes-desktop/package.json krillnotes-desktop/package-lock.json
git commit -m "chore: add i18next and react-i18next"
```

---

### Task 2: Create the i18n init module

**Files:**
- Create: `krillnotes-desktop/src/i18n/index.ts`
- Create: `krillnotes-desktop/src/i18n/locales/en.json` (stub ‚Äî full content in Task 3)
- Modify: `krillnotes-desktop/src/main.tsx`

**Step 1: Create the directory and stub locale**

Create `krillnotes-desktop/src/i18n/locales/en.json` with:

```json
{
  "common": {
    "save": "Save"
  }
}
```

**Step 2: Create `src/i18n/index.ts`**

```ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

import en from './locales/en.json';
import de from './locales/de.json';
import fr from './locales/fr.json';
import es from './locales/es.json';
import ja from './locales/ja.json';
import ko from './locales/ko.json';
import zh from './locales/zh.json';

i18n.use(initReactI18next).init({
  resources: {
    en: { translation: en },
    de: { translation: de },
    fr: { translation: fr },
    es: { translation: es },
    ja: { translation: ja },
    ko: { translation: ko },
    zh: { translation: zh },
  },
  lng: 'en',
  fallbackLng: 'en',
  interpolation: {
    escapeValue: false, // React escapes output already
  },
});

export default i18n;
```

**Step 3: Create stub files for all other locales**

Create each of these with identical content (copy of the en stub):

- `krillnotes-desktop/src/i18n/locales/de.json`
- `krillnotes-desktop/src/i18n/locales/fr.json`
- `krillnotes-desktop/src/i18n/locales/es.json`
- `krillnotes-desktop/src/i18n/locales/ja.json`
- `krillnotes-desktop/src/i18n/locales/ko.json`
- `krillnotes-desktop/src/i18n/locales/zh.json`

Each stub:
```json
{ "common": { "save": "Save" } }
```

**Step 4: Import i18n before React renders in `src/main.tsx`**

Add one import at the very top of the file, before the React imports:

```ts
import './i18n'; // initialise i18next before React renders
```

**Step 5: Verify TypeScript compiles**

Run from `krillnotes-desktop/`:

```bash
npx tsc --noEmit
```

Expected: no errors.

**Step 6: Commit**

```bash
git add krillnotes-desktop/src/i18n/ krillnotes-desktop/src/main.tsx
git commit -m "feat(i18n): add i18next init module and locale stubs"
```

---

### Task 3: Write the full English translation file

**Files:**
- Modify: `krillnotes-desktop/src/i18n/locales/en.json`

**Step 1: Replace the stub with the full catalog**

Replace `en.json` with:

```json
{
  "common": {
    "save": "Save",
    "saving": "Saving...",
    "cancel": "Cancel",
    "close": "Close",
    "delete": "Delete",
    "edit": "Edit",
    "view": "View",
    "replace": "Replace",
    "confirm": "Confirm",
    "back": "‚Üê Back",
    "browse": "Browse...",
    "import": "Import",
    "importing": "Importing...",
    "create": "Create",
    "creating": "Creating...",
    "open": "Open",
    "encrypt": "Encrypt",
    "next": "Next",
    "add": "+ Add",
    "yes": "Yes",
    "no": "No"
  },
  "settings": {
    "title": "Settings",
    "workspaceDir": "Default Workspace Directory",
    "workspaceDirHint": "New workspaces will be created in this directory.",
    "rememberPasswords": "Remember workspace passwords for this session",
    "rememberPasswordsHint": "Passwords are kept in memory until the app closes. Off by default.",
    "appearance": "Appearance",
    "mode": "Mode",
    "lightTheme": "Light theme",
    "darkTheme": "Dark theme",
    "lightBuiltIn": "light (built-in)",
    "darkBuiltIn": "dark (built-in)",
    "manageThemes": "Manage Themes\u2026",
    "language": "Language",
    "failedLoad": "Failed to load settings: {{error}}",
    "failedSave": "Failed to save settings: {{error}}"
  },
  "themes": {
    "manage": "Manage Themes",
    "newTheme": "New Theme",
    "editing": "Editing: {{name}}",
    "builtIn": "built-in",
    "light": "light",
    "dark": "dark",
    "setLight": "Set Light",
    "setDark": "Set Dark",
    "activeLight": "\u2713 Light",
    "activeDark": "\u2713 Dark",
    "newThemeButton": "+ New Theme",
    "importFromFile": "Import from file\u2026",
    "invalidJson": "Invalid JSON \u2014 check for syntax errors.",
    "builtInReadOnly": "Built-in themes are read-only. Create a new theme to customise colours and typography.",
    "builtInLightInfo": "This is the default light theme. Create a new theme that extends it by setting \"light-theme\": {}.",
    "builtInDarkInfo": "This is the default dark theme. Create a new theme that extends it by setting \"dark-theme\": {}.",
    "deleteConfirm": "Delete theme \"{{name}}\"?",
    "conflictWarning": "A theme named \"{{name}}\" already exists. Saving will replace it.",
    "failedRead": "Failed to read theme: {{error}}",
    "failedDelete": "Failed to delete: {{error}}",
    "failedImport": "Failed to read file: {{error}}",
    "invalidImport": "Invalid theme file \u2014 could not parse JSON."
  },
  "scripts": {
    "title": "User Scripts",
    "editing": "Edit: {{name}}",
    "newScript": "New Script",
    "importFromFile": "Import from file\u2026",
    "noScripts": "No user scripts yet. Click \"+ Add\" to create one.",
    "unnamed": "(unnamed)",
    "disableScript": "Disable script",
    "enableScript": "Enable script",
    "deleteWarning": "Deleting this script may remove schema definitions used by existing notes. Their data will be preserved in the database but may not display correctly until a compatible schema is re-registered. Delete anyway?",
    "replaceConfirm": "Replace script \"{{name}}\"? This cannot be undone.",
    "conflictWarning": "A script named \"{{name}}\" already exists. Saving will replace it.",
    "failedLoad": "Failed to load scripts: {{error}}",
    "failedToggle": "Failed to toggle script: {{error}}",
    "failedDelete": "Failed to delete: {{error}}",
    "failedImport": "Failed to read file: {{error}}",
    "reloadErrors": "Script reload errors:\n{{errors}}"
  },
  "workspace": {
    "openTitle": "Open Workspace",
    "newTitle": "New Workspace",
    "loading": "Loading...",
    "noWorkspaces": "No workspaces found in the default directory.\nUse \"New Workspace\" to create one.",
    "alreadyOpen": "Already open",
    "nameLabel": "Workspace Name",
    "namePlaceholder": "My Workspace",
    "savedTo": "Will be saved to: {{path}}",
    "nameRequired": "Please enter a workspace name.",
    "nameInvalid": "Name must contain at least one letter or number.",
    "propertiesTitle": "Workspace Properties",
    "propertiesHint": "This information is embedded in the exported .krillnotes archive and can be used by template galleries to display information about this workspace.",
    "authorName": "Author Name",
    "authorNamePlaceholder": "e.g. Jane Smith",
    "authorOrg": "Author Organisation",
    "authorOrgPlaceholder": "e.g. ACME Corp",
    "homepageUrl": "Homepage URL",
    "homepageUrlPlaceholder": "https://example.com",
    "description": "Description",
    "descriptionPlaceholder": "A short description of this workspace template\u2026",
    "language": "Language",
    "languagePlaceholder": "e.g. en",
    "license": "License",
    "licenseSelect": "\u2014 select a license \u2014",
    "licenseCustom": "Other\u2026",
    "licenseCustomPlaceholder": "Enter license name\u2026",
    "licenseUrl": "License URL",
    "licenseUrlPlaceholder": "https://creativecommons.org/licenses/by/4.0/",
    "workspaceTags": "Workspace Tags",
    "workspaceTagsPlaceholder": "e.g. productivity, zettelkasten, notes",
    "workspaceTagsHint": "Comma-separated tags for gallery discovery. These are separate from per-note tags.",
    "noTagsYet": "No tags yet",
    "failedList": "Failed to list workspaces: {{error}}",
    "failedLoad": "Failed to load notes: {{error}}",
    "treeActionFailed": "Tree action failed: {{error}}",
    "propertiesSaveFailed": "Failed to save workspace properties: {{error}}",
    "exportSuccess": "Workspace exported successfully",
    "exportFailed": "Export failed: {{error}}",
    "importSuccess": "Imported {{noteCount}} notes and {{scriptCount}} scripts",
    "importFailed": "Import failed: {{error}}",
    "importingProgress": "Importing {{noteCount}} notes and {{scriptCount}} scripts."
  },
  "dialogs": {
    "password": {
      "setTitle": "Set Password",
      "enterTitle": "Enter Password",
      "passwordLabel": "Password",
      "confirmLabel": "Confirm Password",
      "passwordPlaceholder": "Enter password",
      "confirmPlaceholder": "Confirm password",
      "repeatPlaceholder": "Repeat password",
      "workspacePasswordPlaceholder": "Workspace password",
      "required": "Please enter a password.",
      "mismatch": "Passwords do not match.",
      "wrongPassword": "Wrong password \u2014 please try again.",
      "incorrectTryAgain": "Incorrect password \u2014 try again.",
      "legacyWorkspace": "This workspace was created with an older version of Krillnotes.\nPlease open it in the previous version, export it via File \u2192 Export Workspace, then import it here.",
      "protectPrompt": "Protect with a password?",
      "protectHint": "Leave blank to export without encryption.",
      "optionalPlaceholder": "Optional password",
      "skipNoEncryption": "Skip \u2014 no encryption",
      "archiveProtected": "This archive is password-protected",
      "archiveHint": "Enter the password used when the workspace was exported."
    },
    "import": {
      "title": "Import Workspace",
      "importedPlaceholder": "imported-workspace",
      "versionMismatch": "This export was created with Krillnotes v{{version}}, but you are running v{{currentVersion}}. Some data may not import correctly.\n\nImport anyway?",
      "versionMismatchTitle": "Version Mismatch"
    },
    "export": {
      "title": "Export Workspace"
    },
    "delete": {
      "confirm": "Discard changes?"
    }
  },
  "notes": {
    "addRoot": "Add Root Note",
    "addChild": "Add Child Note",
    "addSibling": "Add Sibling Note",
    "addChildShort": "Add Child",
    "addSiblingShort": "Add Sibling",
    "copyNote": "Copy Note",
    "pasteAsChild": "Paste as Child",
    "pasteAsSibling": "Paste as Sibling",
    "noteType": "Note Type",
    "noAllowedTypes": "No note types are allowed at this position.",
    "failedCreate": "Failed to create note: {{error}}",
    "noNotes": "No notes yet",
    "fields": "Fields",
    "legacyFields": "Legacy Fields",
    "noFields": "No fields",
    "info": "Info",
    "type": "Type",
    "created": "Created",
    "modified": "Modified",
    "id": "ID",
    "discardChanges": "Discard changes?"
  },
  "fields": {
    "notRated": "Not rated",
    "unknown": "(unknown type)",
    "notSet": "\u2014",
    "yesLabel": "Yes",
    "noLabel": "No",
    "clearLink": "Clear link",
    "noOptions": "No options configured",
    "selectPlaceholder": "\u2014 select \u2014",
    "searchPlaceholder": "Search for a note\u2026",
    "linkedNote": "(linked note)"
  },
  "tags": {
    "addPlaceholder": "Add tag\u2026",
    "remove": "Remove tag {{tag}}"
  },
  "search": {
    "placeholder": "Search notes...",
    "noResults": "No notes found."
  },
  "tree": {
    "collapse": "Collapse",
    "expand": "Expand"
  },
  "log": {
    "title": "Operations Log",
    "allTypes": "All types",
    "from": "From:",
    "to": "To:",
    "noOperations": "No operations found.",
    "dateTime": "Date & Time",
    "target": "Target",
    "type": "Type",
    "count_one": "{{count}} operation",
    "count_other": "{{count}} operations",
    "deleteAll": "Delete all operations?",
    "purgeAll": "Purge All"
  },
  "empty": {
    "getStarted": "Use File > New Workspace or File > Open Workspace to get started"
  }
}
```

**Step 2: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

Expected: no errors.

**Step 3: Commit**

```bash
git add krillnotes-desktop/src/i18n/locales/en.json
git commit -m "feat(i18n): full English translation catalog (120 keys)"
```

---

### Task 4: Add `language` field to Rust AppSettings

**Files:**
- Modify: `krillnotes-desktop/src-tauri/src/settings.rs`

**Step 1: Write the failing test**

In `settings.rs`, add to the existing `#[cfg(test)]` block:

```rust
#[test]
fn deserializes_legacy_settings_without_language_field() {
    let json = r#"{"workspaceDirectory":"/tmp","cacheWorkspacePasswords":false}"#;
    let s: AppSettings = serde_json::from_str(json).unwrap();
    assert_eq!(s.language, "en");
}
```

**Step 2: Run test to verify it fails**

Run from `krillnotes-desktop/src-tauri/`:

```bash
cargo test deserializes_legacy_settings_without_language_field
```

Expected: compile error ‚Äî field `language` not found.

**Step 3: Add the field to the struct**

In `AppSettings`, add after `dark_theme`:

```rust
/// Language code for the UI ("en", "de", "fr", "es", "ja", "ko", "zh").
#[serde(default = "default_language")]
pub language: String,
```

Add the default function near the other defaults:

```rust
fn default_language() -> String { "en".to_string() }
```

Add to the `Default` impl:

```rust
language: default_language(),
```

**Step 4: Run all Rust tests**

```bash
cargo test
```

Expected: all tests pass (was 235+ before this change).

**Step 5: Commit**

```bash
git add src-tauri/src/settings.rs
git commit -m "feat(i18n): add language field to AppSettings"
```

---

### Task 5: Wire language to TypeScript types and startup

**Files:**
- Modify: `krillnotes-desktop/src/types.ts`
- Modify: `krillnotes-desktop/src/App.tsx`

**Step 1: Add `language` to `AppSettings` in types.ts**

In the `AppSettings` interface, add after `darkTheme?`:

```ts
language?: string;
```

**Step 2: Apply language on startup in App.tsx**

At the top of `App.tsx`, add the import:

```ts
import i18n from './i18n';
```

Find the existing `useEffect` that calls `get_settings` (or wherever settings are loaded on startup). After loading the settings, add:

```ts
if (s.language) {
  i18n.changeLanguage(s.language);
}
```

If settings are not loaded in `App.tsx` already, add:

```ts
useEffect(() => {
  invoke<AppSettings>('get_settings').then(s => {
    if (s.language) i18n.changeLanguage(s.language);
  });
}, []);
```

**Step 3: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

Expected: no errors.

**Step 4: Commit**

```bash
git add krillnotes-desktop/src/types.ts krillnotes-desktop/src/App.tsx
git commit -m "feat(i18n): apply language from settings on startup"
```

---

### Task 6: Language dropdown in SettingsDialog

**Files:**
- Modify: `krillnotes-desktop/src/components/SettingsDialog.tsx`

**Step 1: Add imports and state**

At the top of `SettingsDialog.tsx`, add:

```ts
import i18n from '../i18n';
import { useTranslation } from 'react-i18next';
```

Inside the component, add:

```ts
const { t } = useTranslation();
const [language, setLanguage] = useState('en');
const [originalLanguage, setOriginalLanguage] = useState('en');
```

**Step 2: Load language in the existing `useEffect`**

Inside the effect that calls `get_settings`, add after setting other state:

```ts
setLanguage(s.language ?? 'en');
setOriginalLanguage(s.language ?? 'en');
```

**Step 3: Handle live preview**

Add a handler called when the dropdown changes:

```ts
const handleLanguageChange = (lang: string) => {
  setLanguage(lang);
  i18n.changeLanguage(lang); // live preview
};
```

**Step 4: Revert on Cancel**

Update the `onClose` handler (or wrap it) to revert the language if cancelled:

```ts
const handleClose = () => {
  i18n.changeLanguage(originalLanguage); // revert preview
  onClose();
};
```

Use `handleClose` everywhere `onClose` was called directly in the JSX (the Cancel button and Escape key handler).

**Step 5: Persist on Save**

In `handleSave`, add `language` to the patch sent to `update_settings`:

```ts
await invoke('update_settings', {
  patch: {
    workspaceDirectory: workspaceDir,
    cacheWorkspacePasswords: cachePasswords,
    language,
  },
});
setOriginalLanguage(language); // now committed, no revert needed
```

**Step 6: Add the language dropdown to JSX**

In the Appearance section, add this row **above** the Mode toggle:

```tsx
<div className="flex items-center gap-2 mb-3">
  <span className="text-sm text-muted-foreground w-24">{t('settings.language')}</span>
  <select
    value={language}
    onChange={e => handleLanguageChange(e.target.value)}
    className="text-sm border border-border rounded px-2 py-1 bg-background text-foreground"
  >
    <option value="en">English</option>
    <option value="de">Deutsch (de)</option>
    <option value="fr">Fran√ßais (fr)</option>
    <option value="es">Espa√±ol (es)</option>
    <option value="ja">Êó•Êú¨Ë™û (ja)</option>
    <option value="ko">ÌïúÍµ≠Ïñ¥ (ko)</option>
    <option value="zh">‰∏≠Êñá (zh)</option>
  </select>
</div>
```

**Step 7: Verify TypeScript compiles and run the app to test**

```bash
npx tsc --noEmit
```

Open Settings, switch language to Deutsch ‚Äî the "Settings" title and "Language" label should switch instantly (only keys already wired with `t()` will change at this point, which is just the two we added above ‚Äî the rest come in later tasks).

**Step 8: Commit**

```bash
git add krillnotes-desktop/src/components/SettingsDialog.tsx
git commit -m "feat(i18n): language dropdown in Settings with live preview"
```

---

### Task 7: Translate common dialogs

**Files:**
- Modify: `krillnotes-desktop/src/components/SetPasswordDialog.tsx`
- Modify: `krillnotes-desktop/src/components/EnterPasswordDialog.tsx`
- Modify: `krillnotes-desktop/src/components/DeleteConfirmDialog.tsx`

For **each file**, the pattern is:

1. Add at the top: `import { useTranslation } from 'react-i18next';`
2. Inside the component: `const { t } = useTranslation();`
3. Replace every hardcoded string with the matching `t('key')` call.

**SetPasswordDialog.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Set Password"` | `t('dialogs.password.setTitle')` |
| `"Password"` | `t('dialogs.password.passwordLabel')` |
| `"Enter password"` placeholder | `t('dialogs.password.passwordPlaceholder')` |
| `"Confirm Password"` | `t('dialogs.password.confirmLabel')` |
| `"Repeat password"` placeholder | `t('dialogs.password.repeatPlaceholder')` |
| `"Please enter a password."` | `t('dialogs.password.required')` |
| `"Passwords do not match."` | `t('dialogs.password.mismatch')` |
| `"Cancel"` | `t('common.cancel')` |
| `"Confirm"` | `t('common.confirm')` |

**EnterPasswordDialog.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Enter Password"` | `t('dialogs.password.enterTitle')` |
| `"Workspace password"` placeholder | `t('dialogs.password.workspacePasswordPlaceholder')` |
| `"Wrong password ‚Äî please try again."` | `t('dialogs.password.wrongPassword')` |
| long legacy message | `t('dialogs.password.legacyWorkspace')` |
| `"Cancel"` | `t('common.cancel')` |
| `"Open"` | `t('common.open')` |

**DeleteConfirmDialog.tsx** ‚Äî read the file first; replace any "Delete", "Cancel", "Confirm" labels.

**Step N: Verify TypeScript compiles after each file**

```bash
npx tsc --noEmit
```

**Step N+1: Commit**

```bash
git add krillnotes-desktop/src/components/SetPasswordDialog.tsx \
        krillnotes-desktop/src/components/EnterPasswordDialog.tsx \
        krillnotes-desktop/src/components/DeleteConfirmDialog.tsx
git commit -m "feat(i18n): translate password and delete dialogs"
```

---

### Task 8: Translate workspace dialogs

**Files:**
- Modify: `krillnotes-desktop/src/components/OpenWorkspaceDialog.tsx`
- Modify: `krillnotes-desktop/src/components/NewWorkspaceDialog.tsx`
- Modify: `krillnotes-desktop/src/components/WorkspacePropertiesDialog.tsx`

Same pattern: import `useTranslation`, destructure `t`, replace strings.

**OpenWorkspaceDialog.tsx** key replacements:

| Hardcoded | Key |
|---|---|
| `"Open Workspace"` | `t('workspace.openTitle')` |
| `"Loading..."` | `t('workspace.loading')` |
| no-workspaces message | `t('workspace.noWorkspaces')` |
| `"Already open"` | `t('workspace.alreadyOpen')` |
| `"Cancel"` | `t('common.cancel')` |
| error message | `t('workspace.failedList', { error })` |

**NewWorkspaceDialog.tsx** key replacements:

| Hardcoded | Key |
|---|---|
| `"New Workspace"` | `t('workspace.newTitle')` |
| `"Workspace Name"` | `t('workspace.nameLabel')` |
| `"My Workspace"` placeholder | `t('workspace.namePlaceholder')` |
| `"Will be saved to: ‚Ä¶"` | `t('workspace.savedTo', { path })` |
| `"Please enter a workspace name."` | `t('workspace.nameRequired')` |
| `"Name must contain at least one letter or number."` | `t('workspace.nameInvalid')` |
| `"Cancel"` | `t('common.cancel')` |
| `"Next"` | `t('common.next')` |

**WorkspacePropertiesDialog.tsx** key replacements:

| Hardcoded | Key |
|---|---|
| `"Workspace Properties"` | `t('workspace.propertiesTitle')` |
| helper text paragraph | `t('workspace.propertiesHint')` |
| `"Author Name"` | `t('workspace.authorName')` |
| ‚Ä¶ (all field labels and placeholders) | matching `workspace.*` keys |
| `"Cancel"` | `t('common.cancel')` |
| `"Saving‚Ä¶"` | `t('common.saving')` |
| `"Save"` | `t('common.save')` |
| error | `t('workspace.propertiesSaveFailed', { error })` |

**Step N: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

**Step N+1: Commit**

```bash
git add krillnotes-desktop/src/components/OpenWorkspaceDialog.tsx \
        krillnotes-desktop/src/components/NewWorkspaceDialog.tsx \
        krillnotes-desktop/src/components/WorkspacePropertiesDialog.tsx
git commit -m "feat(i18n): translate workspace dialogs"
```

---

### Task 9: Translate notes UI

**Files:**
- Modify: `krillnotes-desktop/src/components/AddNoteDialog.tsx`
- Modify: `krillnotes-desktop/src/components/ContextMenu.tsx`
- Modify: `krillnotes-desktop/src/components/InfoPanel.tsx`
- Modify: `krillnotes-desktop/src/components/TreeNode.tsx`
- Modify: `krillnotes-desktop/src/components/TreeView.tsx`
- Modify: `krillnotes-desktop/src/components/EmptyState.tsx`

**AddNoteDialog.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Add Root Note"` | `t('notes.addRoot')` |
| `"Add Child Note"` | `t('notes.addChild')` |
| `"Add Sibling Note"` | `t('notes.addSibling')` |
| `"Note Type"` | `t('notes.noteType')` |
| no-types error | `t('notes.noAllowedTypes')` |
| create error | `t('notes.failedCreate', { error })` |
| `"Cancel"` | `t('common.cancel')` |
| `"Creating..."` | `t('common.creating')` |
| `"Create"` | `t('common.create')` |

**ContextMenu.tsx** replacements (map each menu item):

| Hardcoded | Key |
|---|---|
| `"Add Root Note"` | `t('notes.addRoot')` |
| `"Add Child"` | `t('notes.addChildShort')` |
| `"Add Sibling"` | `t('notes.addSiblingShort')` |
| `"Edit"` | `t('common.edit')` |
| `"Copy Note"` | `t('notes.copyNote')` |
| `"Paste as Child"` | `t('notes.pasteAsChild')` |
| `"Paste as Sibling"` | `t('notes.pasteAsSibling')` |
| `"Delete"` | `t('common.delete')` |

**InfoPanel.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Select a note to view details"` | `t('notes.noNotes')` ‚Äî or add a dedicated key |
| `"Save"` | `t('common.save')` |
| `"Cancel"` | `t('common.cancel')` |
| `"Edit"` | `t('common.edit')` |
| `"Delete"` | `t('common.delete')` |
| `"‚Üê Back to \"‚Ä¶\""` | `t('notes.backTo', { title: backNoteTitle })` ‚Äî add this key to en.json: `"backTo": "‚Üê Back to \"{{title}}\""` |
| `"Add tag‚Ä¶"` | `t('tags.addPlaceholder')` |
| `"Fields"` | `t('notes.fields')` |
| `"Legacy Fields"` | `t('notes.legacyFields')` |
| `"No fields"` | `t('notes.noFields')` |
| `"Info"` | `t('notes.info')` |
| `"Type"` | `t('notes.type')` |
| `"Created"` | `t('notes.created')` |
| `"Modified"` | `t('notes.modified')` |
| `"ID"` | `t('notes.id')` |
| `"Discard changes?"` | `t('notes.discardChanges')` |

**TreeNode.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Collapse"` aria-label | `t('tree.collapse')` |
| `"Expand"` aria-label | `t('tree.expand')` |

**TreeView.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"No notes yet"` | `t('notes.noNotes')` |

**EmptyState.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Use File > New Workspace‚Ä¶"` | `t('empty.getStarted')` |

**Step N: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

**Step N+1: Commit**

```bash
git add krillnotes-desktop/src/components/AddNoteDialog.tsx \
        krillnotes-desktop/src/components/ContextMenu.tsx \
        krillnotes-desktop/src/components/InfoPanel.tsx \
        krillnotes-desktop/src/components/TreeNode.tsx \
        krillnotes-desktop/src/components/TreeView.tsx \
        krillnotes-desktop/src/components/EmptyState.tsx
git commit -m "feat(i18n): translate notes and tree UI"
```

---

### Task 10: Translate fields, search, tags, hover tooltip

**Files:**
- Modify: `krillnotes-desktop/src/components/FieldDisplay.tsx`
- Modify: `krillnotes-desktop/src/components/FieldEditor.tsx`
- Modify: `krillnotes-desktop/src/components/NoteLinkEditor.tsx`
- Modify: `krillnotes-desktop/src/components/SearchBar.tsx`
- Modify: `krillnotes-desktop/src/components/HoverTooltip.tsx`
- Modify: `krillnotes-desktop/src/components/TagPill.tsx`

Note: `FieldDisplay` and `FieldEditor` render child elements, so they need `useTranslation()`. `TagPill` is likely a small component ‚Äî check if it already has other hooks.

**FieldDisplay.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Not rated"` | `t('fields.notRated')` |
| `"Yes"` aria-label | `t('fields.yesLabel')` |
| `"No"` aria-label | `t('fields.noLabel')` |
| `"(unknown type)"` | `t('fields.unknown')` |
| `"‚Äî"` (null date) | `t('fields.notSet')` |

**FieldEditor.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"No options configured"` | `t('fields.noOptions')` |
| `"‚Äî select ‚Äî"` | `t('fields.selectPlaceholder')` |
| star aria-label (keep dynamic) | construct with `t` |

**NoteLinkEditor.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Search for a note‚Ä¶"` placeholder | `t('fields.searchPlaceholder')` |
| `"Clear link"` title | `t('fields.clearLink')` |

**SearchBar.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Search notes..."` placeholder | `t('search.placeholder')` |
| `"No notes found."` | `t('search.noResults')` |

**HoverTooltip.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"(linked note)"` | `t('fields.linkedNote')` |

**TagPill.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Remove tag {{tag}}"` aria-label | `t('tags.remove', { tag })` |

**Step N: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

**Step N+1: Commit**

```bash
git add krillnotes-desktop/src/components/FieldDisplay.tsx \
        krillnotes-desktop/src/components/FieldEditor.tsx \
        krillnotes-desktop/src/components/NoteLinkEditor.tsx \
        krillnotes-desktop/src/components/SearchBar.tsx \
        krillnotes-desktop/src/components/HoverTooltip.tsx \
        krillnotes-desktop/src/components/TagPill.tsx
git commit -m "feat(i18n): translate field, search, tag, tooltip components"
```

---

### Task 11: Translate ManageThemesDialog

**Files:**
- Modify: `krillnotes-desktop/src/components/ManageThemesDialog.tsx`

This is the largest single component (~405 lines). Read the full file before editing. Add `useTranslation` and replace every string using the `themes.*` and `common.*` keys from `en.json`.

Key replacements to watch for:
- Dynamic strings: `"Editing: {{name}}"` ‚Üí `t('themes.editing', { name: themeName })`
- The `"‚úì Light"` / `"Set Light"` conditional buttons
- The `"‚Üê Back"` button ‚Üí `t('common.back')`
- The `"+ New Theme"` button ‚Üí `t('themes.newThemeButton')`
- `"Import from file‚Ä¶"` ‚Üí `t('themes.importFromFile')`
- `"light (built-in)"` / `"dark (built-in)"` in the SettingsDialog are already covered by `settings.lightBuiltIn` / `settings.darkBuiltIn` but the same strings appear in ManageThemesDialog too ‚Äî use `themes.builtIn` tag badge and construct as needed.

**Step N: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

**Step N+1: Commit**

```bash
git add krillnotes-desktop/src/components/ManageThemesDialog.tsx
git commit -m "feat(i18n): translate ManageThemesDialog"
```

---

### Task 12: Translate ScriptManagerDialog

**Files:**
- Modify: `krillnotes-desktop/src/components/ScriptManagerDialog.tsx`

Read the full file first. Add `useTranslation` and replace all strings using `scripts.*` and `common.*` keys.

Key dynamic replacements:
- `"Edit: {{name}}"` ‚Üí `t('scripts.editing', { name: scriptName })`
- `"No user scripts yet. Click \"+ Add\" to create one."` ‚Üí `t('scripts.noScripts')`
- Script reload errors (multi-line) ‚Üí `t('scripts.reloadErrors', { errors: errStr })`
- Conflict warning ‚Üí `t('scripts.conflictWarning', { name: scriptName })`

**Step N: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

**Step N+1: Commit**

```bash
git add krillnotes-desktop/src/components/ScriptManagerDialog.tsx
git commit -m "feat(i18n): translate ScriptManagerDialog"
```

---

### Task 13: Translate App.tsx

**Files:**
- Modify: `krillnotes-desktop/src/App.tsx`

`App.tsx` handles import/export dialogs, inline password prompt UI, and status messages. Read the full file first.

Note: `App.tsx` is a function component, so `useTranslation()` works normally. The `i18n` import from Task 5 is already there; add `useTranslation` from it too:

```ts
import { useTranslation } from 'react-i18next';
// inside component:
const { t } = useTranslation();
```

Key replacements:
- All status messages (`setStatus(...)`) ‚Üí `t('workspace.importSuccess', { noteCount, scriptCount })` etc.
- All error messages ‚Üí matching `workspace.*` / `dialogs.*` keys
- Inline JSX labels (password prompt UI, import dialog) ‚Üí `dialogs.password.*` / `dialogs.import.*` keys
- `"Workspace exported successfully"` ‚Üí `t('workspace.exportSuccess')`
- Version mismatch confirm text ‚Üí `t('dialogs.import.versionMismatch', { version, currentVersion })`

**Step N: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

**Step N+1: Commit**

```bash
git add krillnotes-desktop/src/App.tsx
git commit -m "feat(i18n): translate App.tsx import/export and password flows"
```

---

### Task 14: Translate WorkspaceView and OperationsLogDialog

**Files:**
- Modify: `krillnotes-desktop/src/components/WorkspaceView.tsx`
- Modify: `krillnotes-desktop/src/components/OperationsLogDialog.tsx`

**WorkspaceView.tsx** ‚Äî primarily error messages and the "No tags yet" empty state:

| Hardcoded | Key |
|---|---|
| `"Failed to load notes: ‚Ä¶"` | `t('workspace.failedLoad', { error })` |
| `"Tree action failed: ‚Ä¶"` | `t('workspace.treeActionFailed', { error })` |
| `"No tags yet"` | `t('workspace.noTagsYet')` |

**OperationsLogDialog.tsx** replacements:

| Hardcoded | Key |
|---|---|
| `"Operations Log"` | `t('log.title')` |
| `"All types"` | `t('log.allTypes')` |
| `"From:"` | `t('log.from')` |
| `"To:"` | `t('log.to')` |
| `"No operations found."` | `t('log.noOperations')` |
| `"Date & Time"` | `t('log.dateTime')` |
| `"Target"` | `t('log.target')` |
| `"Type"` | `t('log.type')` |
| count footer | `t('log.count', { count })` ‚Äî i18next uses `count_one`/`count_other` automatically |
| `"Delete all operations?"` | `t('log.deleteAll')` |
| `"Purge All"` | `t('log.purgeAll')` |
| `"Confirm"` | `t('common.confirm')` |
| `"Cancel"` | `t('common.cancel')` |

**Step N: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

**Step N+1: Commit**

```bash
git add krillnotes-desktop/src/components/WorkspaceView.tsx \
        krillnotes-desktop/src/components/OperationsLogDialog.tsx
git commit -m "feat(i18n): translate WorkspaceView and OperationsLogDialog"
```

---

### Task 15: Locale-aware date and number formatting

**Files:**
- Modify: `krillnotes-desktop/src/components/FieldDisplay.tsx`

**Step 1: Import i18n**

Add at the top of `FieldDisplay.tsx`:

```ts
import i18n from '../i18n';
```

**Step 2: Update date formatting**

Find the `toLocaleDateString(undefined, ...)` call and replace `undefined` with `i18n.language`:

```ts
// Before
new Date(`${value.Date}T00:00:00`).toLocaleDateString(undefined, {
  year: 'numeric', month: 'long', day: 'numeric',
})

// After
new Date(`${value.Date}T00:00:00`).toLocaleDateString(i18n.language, {
  year: 'numeric', month: 'long', day: 'numeric',
})
```

**Step 3: Update number formatting**

Find the plain number render (`<p>{value.Number}</p>`) and update to:

```tsx
<p>{value.Number.toLocaleString(i18n.language)}</p>
```

**Step 4: Manual test**

Switch language to Deutsch, open a note with a Date field ‚Äî the date should render as `"28. Februar 2026"`. A number like `1234.5` should render as `"1.234,5"`.

**Step 5: Verify TypeScript compiles**

```bash
npx tsc --noEmit
```

**Step 6: Commit**

```bash
git add krillnotes-desktop/src/components/FieldDisplay.tsx
git commit -m "feat(i18n): locale-aware date and number formatting"
```

---

### Task 16: Create the translated locale files

**Files:**
- Modify: `krillnotes-desktop/src/i18n/locales/de.json`
- Modify: `krillnotes-desktop/src/i18n/locales/fr.json`
- Modify: `krillnotes-desktop/src/i18n/locales/es.json`
- Modify: `krillnotes-desktop/src/i18n/locales/ja.json`
- Modify: `krillnotes-desktop/src/i18n/locales/ko.json`
- Modify: `krillnotes-desktop/src/i18n/locales/zh.json`

**Step 1: Translate all keys for each language**

Each locale file must contain all the same keys as `en.json`, translated into the target language. Use the `en.json` from Task 3 as the source of truth. Preserve all interpolation placeholders exactly (`{{error}}`, `{{count}}`, `{{name}}`, etc.).

For the pluralisation keys in German and French, use the `_one` / `_other` convention:

```json
// de.json
"log": {
  "count_one": "{{count}} Vorgang",
  "count_other": "{{count}} Vorg√§nge"
}
```

For Japanese/Korean/Chinese, a single form is sufficient (no grammatical number distinction):

```json
// ja.json
"log": {
  "count": "{{count}} ‰ª∂"
}
```

**Step 2: Verify TypeScript compiles (JSON import check)**

```bash
npx tsc --noEmit
```

**Step 3: Manual spot-check**

Switch the app language to each of the 7 languages in turn. Verify the Settings dialog, main toolbar, and at least one note-detail view all display translated text. Verify no key shows as a raw key string (e.g. `"notes.noNotes"`), which would indicate a missing translation (it should fall back to English, not show the key).

**Step 4: Commit**

```bash
git add krillnotes-desktop/src/i18n/locales/
git commit -m "feat(i18n): add de, fr, es, ja, ko, zh translations"
```

---

### Task 17: Full build verification and QA

**Step 1: Run Rust tests**

From `krillnotes-desktop/src-tauri/`:

```bash
cargo test
```

Expected: all tests pass.

**Step 2: Run TypeScript build**

From `krillnotes-desktop/`:

```bash
npx tsc --noEmit
```

Expected: no errors.

**Step 3: Manual QA checklist**

- [ ] Switch to each of the 7 languages ‚Äî entire UI updates immediately
- [ ] Cancel the Settings dialog after changing language ‚Äî language reverts
- [ ] Save the Settings dialog ‚Äî language persists across app restart
- [ ] Date field in a note: changes format per language (check `de` and `ja`)
- [ ] Number field: check `de` shows comma decimal separator
- [ ] Paste CJK characters into a text field, save, reopen ‚Äî characters preserved (UTF-8 smoke test)
- [ ] All dialogs in German: no untranslated English strings visible
- [ ] Missing-key fallback: temporarily remove one key from `de.json`, switch to German ‚Äî it shows the English fallback, not a raw key

---

### Task 18: Open PR

**Step 1: Push branch**

```bash
git push -u github-https feat/i18n
```

**Step 2: Open PR**

```bash
gh pr create \
  --title "feat: internationalisation ‚Äî 7 language packs, locale-aware formatting (issue #43)" \
  --body "$(cat <<'EOF'
## Summary
- Adds react-i18next with 7 built-in language packs: English, Deutsch, Fran√ßais, Espa√±ol, Êó•Êú¨Ë™û, ÌïúÍµ≠Ïñ¥, ‰∏≠Êñá
- Language selector in Settings > Appearance with live preview and cancel-revert
- ~120 translation keys extracted from all 23 UI components
- Locale-aware date and number formatting in field display (uses selected language, not OS locale)
- UTF-8 verified as already supported end-to-end (no code change needed)

## Test plan
- [ ] Switch through all 7 languages in Settings ‚Äî UI updates live
- [ ] Cancel after changing language ‚Äî reverts correctly
- [ ] Restart app ‚Äî language preference persists
- [ ] Date and number fields format correctly for `de` (comma decimal, long month name in German)
- [ ] CJK text round-trips correctly through text fields
- [ ] `cargo test` passes
- [ ] `tsc --noEmit` passes

Closes #43

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```
