# Tree View Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement hierarchical tree view for browsing notes with selection, expansion state, and note creation

**Architecture:** Split view layout with client-side tree building from flat note list, state persistence in SQLite database

**Tech Stack:** Rust (Tauri v2, rusqlite), TypeScript/React, Tailwind CSS

---

## Task 1: Add is_expanded Column to Notes Table

**Files:**
- Modify: `krillnotes-core/src/core/storage.rs`
- Modify: `krillnotes-core/src/core/note.rs`

**Step 1: Add is_expanded to Note struct**

Add to `krillnotes-core/src/core/note.rs` in the `Note` struct:

```rust
pub struct Note {
    pub id: String,
    pub title: String,
    pub node_type: String,
    pub parent_id: Option<String>,
    pub position: i32,
    pub created_at: i64,
    pub modified_at: i64,
    pub created_by: i64,
    pub modified_by: i64,
    pub fields: HashMap<String, FieldValue>,
    pub is_expanded: bool, // NEW
}
```

**Step 2: Update Storage::create to add column**

Modify the CREATE TABLE in `krillnotes-core/src/core/storage.rs` in `Storage::create()`:

```rust
conn.execute(
    "CREATE TABLE notes (
        id TEXT PRIMARY KEY,
        title TEXT NOT NULL,
        node_type TEXT NOT NULL,
        parent_id TEXT,
        position INTEGER NOT NULL,
        created_at INTEGER NOT NULL,
        modified_at INTEGER NOT NULL,
        created_by INTEGER NOT NULL,
        modified_by INTEGER NOT NULL,
        fields_json TEXT NOT NULL,
        is_expanded INTEGER DEFAULT 1
    )",
    [],
)?;
```

**Step 3: Update Storage::open to add column if missing**

Add migration logic in `krillnotes-core/src/core/storage.rs` in `Storage::open()` after validation:

```rust
// Migrate: add is_expanded column if it doesn't exist
let column_exists: bool = conn
    .query_row(
        "SELECT COUNT(*) FROM pragma_table_info('notes') WHERE name='is_expanded'",
        [],
        |row| row.get::<_, i64>(0).map(|count| count > 0)
    )?;

if !column_exists {
    conn.execute(
        "ALTER TABLE notes ADD COLUMN is_expanded INTEGER DEFAULT 1",
        []
    )?;
}
```

**Step 4: Update Workspace::create to include is_expanded**

Modify INSERT in `krillnotes-core/src/core/workspace.rs` in `Workspace::create()`:

```rust
tx.execute(
    "INSERT INTO notes (id, title, node_type, parent_id, position, created_at, modified_at, created_by, modified_by, fields_json, is_expanded)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",
    rusqlite::params![
        root.id,
        root.title,
        root.node_type,
        root.parent_id,
        root.position,
        root.created_at,
        root.modified_at,
        root.created_by,
        root.modified_by,
        serde_json::to_string(&root.fields)?,
        true, // is_expanded = true for root
    ],
)?;
```

And update the root Note initialization to include `is_expanded: true`.

**Step 5: Update Workspace::list_all_notes to query is_expanded**

Modify SELECT and mapping in `krillnotes-core/src/core/workspace.rs` in `list_all_notes()`:

```rust
let mut stmt = self.connection().prepare(
    "SELECT id, title, node_type, parent_id, position, created_at, modified_at, created_by, modified_by, fields_json, is_expanded
     FROM notes ORDER BY parent_id, position",
)?;

let notes = stmt
    .query_map([], |row| {
        Ok(Note {
            id: row.get(0)?,
            title: row.get(1)?,
            node_type: row.get(2)?,
            parent_id: row.get(3)?,
            position: row.get(4)?,
            created_at: row.get(5)?,
            modified_at: row.get(6)?,
            created_by: row.get(7)?,
            modified_by: row.get(8)?,
            fields: serde_json::from_str(&row.get::<_, String>(9)?).unwrap(),
            is_expanded: row.get::<_, i64>(10)? == 1,
        })
    })?
```

**Step 6: Update Workspace::create_note to include is_expanded**

Modify `create_note()` in `krillnotes-core/src/core/workspace.rs` to insert with `is_expanded`:

```rust
tx.execute(
    "INSERT INTO notes (id, title, node_type, parent_id, position, created_at, modified_at, created_by, modified_by, fields_json, is_expanded)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",
    rusqlite::params![
        new_note.id,
        new_note.title,
        new_note.node_type,
        new_note.parent_id,
        new_note.position,
        new_note.created_at,
        new_note.modified_at,
        new_note.created_by,
        new_note.modified_by,
        serde_json::to_string(&new_note.fields)?,
        true, // Default expanded for new notes
    ],
)?;
```

And add `is_expanded: true` to the `new_note` initialization.

**Step 7: Verify compilation**

Run: `cargo test -p krillnotes-core`
Expected: All tests pass

**Step 8: Commit**

```bash
git add krillnotes-core/src/core/storage.rs krillnotes-core/src/core/note.rs krillnotes-core/src/core/workspace.rs
git commit -m "feat(core): add is_expanded column to notes table

- Add is_expanded boolean to Note struct
- Update schema with is_expanded column (default 1)
- Add migration in Storage::open for existing databases
- Update all INSERT and SELECT queries to include is_expanded

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 2: Add get_node_types Backend Command

**Files:**
- Modify: `krillnotes-desktop/src-tauri/src/lib.rs`

**Step 1: Add command function**

Add after existing commands in `krillnotes-desktop/src-tauri/src/lib.rs`:

```rust
#[tauri::command]
fn get_node_types(
    window: tauri::Window,
    state: State<'_, AppState>,
) -> std::result::Result<Vec<String>, String> {
    let label = window.label();
    let workspaces = state.workspaces.lock()
        .expect("Mutex poisoned");

    let workspace = workspaces.get(label)
        .ok_or("No workspace open")?;

    let types = workspace.list_node_types()
        .map_err(|e| e.to_string())?;

    Ok(types)
}
```

**Step 2: Add list_node_types to Workspace**

Add to `krillnotes-core/src/core/workspace.rs` in `impl Workspace`:

```rust
pub fn list_node_types(&self) -> Result<Vec<String>> {
    self.registry.list_types()
}
```

**Step 3: Add list_types to SchemaRegistry**

Add to `krillnotes-core/src/core/schema.rs` in `impl SchemaRegistry`:

```rust
pub fn list_types(&self) -> Result<Vec<String>> {
    Ok(self.schemas.keys().cloned().collect())
}
```

**Step 4: Register command in run()**

Add to `.invoke_handler` in `run()`:

```rust
.invoke_handler(tauri::generate_handler![
    greet,
    create_workspace,
    open_workspace,
    get_workspace_info,
    list_notes,
    get_node_types, // NEW
])
```

**Step 5: Verify compilation**

Run: `cd krillnotes-desktop/src-tauri && cargo build`
Expected: Compiles successfully

**Step 6: Commit**

```bash
git add krillnotes-desktop/src-tauri/src/lib.rs krillnotes-core/src/core/workspace.rs krillnotes-core/src/core/schema.rs
git commit -m "feat(desktop): add get_node_types command

Returns list of available node types from schema registry

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 3: Add toggle_note_expansion Backend Command

**Files:**
- Modify: `krillnotes-desktop/src-tauri/src/lib.rs`
- Modify: `krillnotes-core/src/core/workspace.rs`

**Step 1: Add toggle_expansion method to Workspace**

Add to `krillnotes-core/src/core/workspace.rs` in `impl Workspace`:

```rust
pub fn toggle_note_expansion(&mut self, note_id: &str) -> Result<()> {
    let tx = self.storage.connection_mut().transaction()?;

    // Get current value
    let current: i64 = tx.query_row(
        "SELECT is_expanded FROM notes WHERE id = ?",
        [note_id],
        |row| row.get(0)
    )?;

    // Toggle
    let new_value = if current == 1 { 0 } else { 1 };

    tx.execute(
        "UPDATE notes SET is_expanded = ? WHERE id = ?",
        rusqlite::params![new_value, note_id],
    )?;

    tx.commit()?;
    Ok(())
}
```

**Step 2: Add Tauri command**

Add to `krillnotes-desktop/src-tauri/src/lib.rs`:

```rust
#[tauri::command]
fn toggle_note_expansion(
    window: tauri::Window,
    state: State<'_, AppState>,
    note_id: String,
) -> std::result::Result<(), String> {
    let label = window.label();
    let mut workspaces = state.workspaces.lock()
        .expect("Mutex poisoned");

    let workspace = workspaces.get_mut(label)
        .ok_or("No workspace open")?;

    workspace.toggle_note_expansion(&note_id)
        .map_err(|e| e.to_string())
}
```

**Step 3: Register command**

Add to `.invoke_handler`:

```rust
.invoke_handler(tauri::generate_handler![
    greet,
    create_workspace,
    open_workspace,
    get_workspace_info,
    list_notes,
    get_node_types,
    toggle_note_expansion, // NEW
])
```

**Step 4: Verify compilation**

Run: `cd krillnotes-desktop/src-tauri && cargo build`
Expected: Compiles successfully

**Step 5: Commit**

```bash
git add krillnotes-core/src/core/workspace.rs krillnotes-desktop/src-tauri/src/lib.rs
git commit -m "feat(desktop): add toggle_note_expansion command

Toggles is_expanded boolean for a note in the database

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 4: Add set_selected_note Backend Command

**Files:**
- Modify: `krillnotes-desktop/src-tauri/src/lib.rs`
- Modify: `krillnotes-core/src/core/workspace.rs`

**Step 1: Add set_selected_note method to Workspace**

Add to `krillnotes-core/src/core/workspace.rs` in `impl Workspace`:

```rust
pub fn set_selected_note(&mut self, note_id: Option<&str>) -> Result<()> {
    let tx = self.storage.connection_mut().transaction()?;

    // Delete existing entry
    tx.execute(
        "DELETE FROM workspace_meta WHERE key = 'selected_note_id'",
        [],
    )?;

    // Insert new value if provided
    if let Some(id) = note_id {
        tx.execute(
            "INSERT INTO workspace_meta (key, value) VALUES ('selected_note_id', ?)",
            [id],
        )?;
    }

    tx.commit()?;
    Ok(())
}
```

**Step 2: Add get_selected_note method to Workspace**

Add to `krillnotes-core/src/core/workspace.rs` in `impl Workspace`:

```rust
pub fn get_selected_note(&self) -> Result<Option<String>> {
    let result = self.storage.connection().query_row(
        "SELECT value FROM workspace_meta WHERE key = 'selected_note_id'",
        [],
        |row| row.get::<_, String>(0)
    );

    match result {
        Ok(id) => Ok(Some(id)),
        Err(rusqlite::Error::QueryReturnedNoRows) => Ok(None),
        Err(e) => Err(e.into()),
    }
}
```

**Step 3: Add Tauri command**

Add to `krillnotes-desktop/src-tauri/src/lib.rs`:

```rust
#[tauri::command]
fn set_selected_note(
    window: tauri::Window,
    state: State<'_, AppState>,
    note_id: Option<String>,
) -> std::result::Result<(), String> {
    let label = window.label();
    let mut workspaces = state.workspaces.lock()
        .expect("Mutex poisoned");

    let workspace = workspaces.get_mut(label)
        .ok_or("No workspace open")?;

    workspace.set_selected_note(note_id.as_deref())
        .map_err(|e| e.to_string())
}
```

**Step 4: Register command**

Add to `.invoke_handler`:

```rust
.invoke_handler(tauri::generate_handler![
    greet,
    create_workspace,
    open_workspace,
    get_workspace_info,
    list_notes,
    get_node_types,
    toggle_note_expansion,
    set_selected_note, // NEW
])
```

**Step 5: Verify compilation**

Run: `cd krillnotes-desktop/src-tauri && cargo build`
Expected: Compiles successfully

**Step 6: Commit**

```bash
git add krillnotes-core/src/core/workspace.rs krillnotes-desktop/src-tauri/src/lib.rs
git commit -m "feat(desktop): add set_selected_note command

Stores selected note ID in workspace_meta table

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 5: Add create_note_with_type Backend Command

**Files:**
- Modify: `krillnotes-desktop/src-tauri/src/lib.rs`

**Step 1: Add Tauri command**

Add to `krillnotes-desktop/src-tauri/src/lib.rs`:

```rust
#[tauri::command]
async fn create_note_with_type(
    window: tauri::Window,
    state: State<'_, AppState>,
    parent_id: Option<String>,
    position: String, // "child" or "sibling"
    node_type: String,
) -> std::result::Result<Note, String> {
    let label = window.label();
    let mut workspaces = state.workspaces.lock()
        .expect("Mutex poisoned");

    let workspace = workspaces.get_mut(label)
        .ok_or("No workspace open")?;

    // Convert position string to AddPosition enum
    let add_position = match position.as_str() {
        "child" => AddPosition::AsChild,
        "sibling" => AddPosition::AsSibling,
        _ => return Err("Invalid position: must be 'child' or 'sibling'".to_string()),
    };

    // If no parent_id, create root note
    let note_id = if let Some(pid) = parent_id {
        workspace.create_note(&pid, add_position, &node_type)
            .map_err(|e| e.to_string())?
    } else {
        // Create root note (parent_id = null, position = 0)
        workspace.create_note_root(&node_type)
            .map_err(|e| e.to_string())?
    };

    // Fetch and return the created note
    workspace.get_note(&note_id)
        .map_err(|e| e.to_string())
}
```

**Step 2: Add create_note_root method to Workspace**

Add to `krillnotes-core/src/core/workspace.rs` in `impl Workspace`:

```rust
pub fn create_note_root(&mut self, node_type: &str) -> Result<String> {
    let now = chrono::Utc::now().timestamp();
    let schema = self.registry.get_schema(node_type)?;

    let new_note = Note {
        id: Uuid::new_v4().to_string(),
        title: "Untitled".to_string(),
        node_type: node_type.to_string(),
        parent_id: None,
        position: 0,
        created_at: now,
        modified_at: now,
        created_by: self.current_user_id,
        modified_by: self.current_user_id,
        fields: schema.default_fields(),
        is_expanded: true,
    };

    let tx = self.storage.connection_mut().transaction()?;

    tx.execute(
        "INSERT INTO notes (id, title, node_type, parent_id, position, created_at, modified_at, created_by, modified_by, fields_json, is_expanded)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)",
        rusqlite::params![
            new_note.id,
            new_note.title,
            new_note.node_type,
            new_note.parent_id,
            new_note.position,
            new_note.created_at,
            new_note.modified_at,
            new_note.created_by,
            new_note.modified_by,
            serde_json::to_string(&new_note.fields)?,
            true,
        ],
    )?;

    tx.commit()?;
    Ok(new_note.id)
}
```

**Step 3: Register command**

Add to `.invoke_handler`:

```rust
.invoke_handler(tauri::generate_handler![
    greet,
    create_workspace,
    open_workspace,
    get_workspace_info,
    list_notes,
    get_node_types,
    toggle_note_expansion,
    set_selected_note,
    create_note_with_type, // NEW
])
```

**Step 4: Verify compilation**

Run: `cd krillnotes-desktop/src-tauri && cargo build`
Expected: Compiles successfully

**Step 5: Commit**

```bash
git add krillnotes-core/src/core/workspace.rs krillnotes-desktop/src-tauri/src/lib.rs
git commit -m "feat(desktop): add create_note_with_type command

Creates note with specified type and position (child/sibling)
Handles root node creation for empty workspaces

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 6: Update WorkspaceInfo to Include selectedNoteId

**Files:**
- Modify: `krillnotes-desktop/src-tauri/src/lib.rs`

**Step 1: Update WorkspaceInfo struct**

Modify in `krillnotes-desktop/src-tauri/src/lib.rs`:

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "camelCase")]
pub struct WorkspaceInfo {
    pub filename: String,
    pub path: String,
    pub note_count: usize,
    pub selected_note_id: Option<String>, // NEW
}
```

**Step 2: Update get_workspace_info_internal to fetch selected_note_id**

Modify in `krillnotes-desktop/src-tauri/src/lib.rs`:

```rust
fn get_workspace_info_internal(
    state: &AppState,
    label: &str
) -> std::result::Result<WorkspaceInfo, String> {
    let workspaces = state.workspaces.lock()
        .expect("Mutex poisoned");
    let paths = state.workspace_paths.lock()
        .expect("Mutex poisoned");

    let workspace = workspaces.get(label)
        .ok_or("No workspace found")?;
    let path = paths.get(label)
        .ok_or("No path found")?;

    let note_count = workspace.list_all_notes()
        .map(|notes| notes.len())
        .unwrap_or(0);

    let filename = path.file_stem()
        .and_then(|s| s.to_str())
        .unwrap_or("Untitled")
        .to_string();

    let selected_note_id = workspace.get_selected_note()
        .ok()
        .flatten();

    Ok(WorkspaceInfo {
        filename,
        path: path.display().to_string(),
        note_count,
        selected_note_id, // NEW
    })
}
```

**Step 3: Verify compilation**

Run: `cd krillnotes-desktop/src-tauri && cargo build`
Expected: Compiles successfully

**Step 4: Commit**

```bash
git add krillnotes-desktop/src-tauri/src/lib.rs
git commit -m "feat(desktop): add selectedNoteId to WorkspaceInfo

Includes currently selected note ID when fetching workspace info

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 7: Update Frontend Types

**Files:**
- Modify: `krillnotes-desktop/src/types.ts`

**Step 1: Update Note interface**

Modify in `krillnotes-desktop/src/types.ts`:

```typescript
export interface Note {
  id: string;
  title: string;
  nodeType: string;
  parentId: string | null;
  position: number;
  createdAt: number;
  modifiedAt: number;
  createdBy: number;
  modifiedBy: number;
  fields: Record<string, FieldValue>;
  isExpanded: boolean; // NEW
}
```

**Step 2: Update WorkspaceInfo interface**

Modify in `krillnotes-desktop/src/types.ts`:

```typescript
export interface WorkspaceInfo {
  filename: string;
  path: string;
  noteCount: number;
  selectedNoteId?: string; // NEW
}
```

**Step 3: Add TreeNode interface**

Add to `krillnotes-desktop/src/types.ts`:

```typescript
export interface TreeNode {
  note: Note;
  children: TreeNode[];
}
```

**Step 4: Verify TypeScript compilation**

Run: `cd krillnotes-desktop && npm run build`
Expected: Compiles successfully (may have unused type warnings, that's okay)

**Step 5: Commit**

```bash
git add krillnotes-desktop/src/types.ts
git commit -m "feat(frontend): update types for tree view

Add isExpanded to Note, selectedNoteId to WorkspaceInfo, and TreeNode interface

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 8: Create buildTree Utility

**Files:**
- Create: `krillnotes-desktop/src/utils/tree.ts`

**Step 1: Create tree utility file**

Create `krillnotes-desktop/src/utils/tree.ts`:

```typescript
import type { Note, TreeNode } from '../types';

/**
 * Builds a tree structure from a flat array of notes.
 * Notes are expected to have parentId and position fields for hierarchy and ordering.
 */
export function buildTree(notes: Note[]): TreeNode[] {
  // 1. Group children by parent_id
  const childrenMap = new Map<string | null, Note[]>();

  notes.forEach(note => {
    const parentId = note.parentId;
    if (!childrenMap.has(parentId)) {
      childrenMap.set(parentId, []);
    }
    childrenMap.get(parentId)!.push(note);
  });

  // 2. Sort siblings by position
  childrenMap.forEach(children => {
    children.sort((a, b) => a.position - b.position);
  });

  // 3. Recursive builder
  function buildNode(note: Note): TreeNode {
    const children = childrenMap.get(note.id) || [];
    return {
      note,
      children: children.map(buildNode)
    };
  }

  // 4. Return root-level nodes (parentId = null)
  const roots = childrenMap.get(null) || [];
  return roots.map(buildNode);
}

/**
 * Finds a note in the tree by ID (depth-first search)
 */
export function findNoteInTree(tree: TreeNode[], noteId: string): TreeNode | null {
  for (const node of tree) {
    if (node.note.id === noteId) {
      return node;
    }
    const found = findNoteInTree(node.children, noteId);
    if (found) {
      return found;
    }
  }
  return null;
}
```

**Step 2: Verify TypeScript compilation**

Run: `cd krillnotes-desktop && npm run build`
Expected: Compiles successfully

**Step 3: Commit**

```bash
git add krillnotes-desktop/src/utils/tree.ts
git commit -m "feat(frontend): add tree building utility

Converts flat note array to hierarchical tree structure

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 9: Create TreeNode Component

**Files:**
- Create: `krillnotes-desktop/src/components/TreeNode.tsx`

**Step 1: Create TreeNode component**

Create `krillnotes-desktop/src/components/TreeNode.tsx`:

```typescript
import type { TreeNode as TreeNodeType } from '../types';

interface TreeNodeProps {
  node: TreeNodeType;
  selectedNoteId: string | null;
  level: number;
  onSelect: (noteId: string) => void;
  onToggleExpand: (noteId: string) => void;
}

function TreeNode({ node, selectedNoteId, level, onSelect, onToggleExpand }: TreeNodeProps) {
  const hasChildren = node.children.length > 0;
  const isSelected = node.note.id === selectedNoteId;
  const isExpanded = node.note.isExpanded;

  return (
    <div>
      <div
        className={`flex items-center py-1 px-2 cursor-pointer hover:bg-secondary/50 ${
          isSelected ? 'bg-secondary' : ''
        }`}
        style={{ paddingLeft: `${level * 20 + 8}px` }}
        onClick={() => onSelect(node.note.id)}
      >
        {hasChildren && (
          <button
            onClick={(e) => {
              e.stopPropagation();
              onToggleExpand(node.note.id);
            }}
            className="mr-1 text-muted-foreground hover:text-foreground"
          >
            {isExpanded ? 'â–¼' : 'â–¶'}
          </button>
        )}
        {!hasChildren && <span className="w-4 mr-1" />}
        <span className="text-sm truncate">{node.note.title}</span>
      </div>

      {hasChildren && isExpanded && (
        <div>
          {node.children.map(child => (
            <TreeNode
              key={child.note.id}
              node={child}
              selectedNoteId={selectedNoteId}
              level={level + 1}
              onSelect={onSelect}
              onToggleExpand={onToggleExpand}
            />
          ))}
        </div>
      )}
    </div>
  );
}

export default TreeNode;
```

**Step 2: Verify TypeScript compilation**

Run: `cd krillnotes-desktop && npm run build`
Expected: Compiles successfully

**Step 3: Commit**

```bash
git add krillnotes-desktop/src/components/TreeNode.tsx
git commit -m "feat(frontend): create TreeNode component

Recursive tree node with expand/collapse and selection

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 10: Create TreeView Component

**Files:**
- Create: `krillnotes-desktop/src/components/TreeView.tsx`

**Step 1: Create TreeView component**

Create `krillnotes-desktop/src/components/TreeView.tsx`:

```typescript
import TreeNode from './TreeNode';
import type { TreeNode as TreeNodeType } from '../types';

interface TreeViewProps {
  tree: TreeNodeType[];
  selectedNoteId: string | null;
  onSelect: (noteId: string) => void;
  onToggleExpand: (noteId: string) => void;
}

function TreeView({ tree, selectedNoteId, onSelect, onToggleExpand }: TreeViewProps) {
  if (tree.length === 0) {
    return (
      <div className="flex items-center justify-center h-full text-muted-foreground text-sm">
        No notes yet
      </div>
    );
  }

  return (
    <div className="overflow-y-auto h-full">
      {tree.map(node => (
        <TreeNode
          key={node.note.id}
          node={node}
          selectedNoteId={selectedNoteId}
          level={0}
          onSelect={onSelect}
          onToggleExpand={onToggleExpand}
        />
      ))}
    </div>
  );
}

export default TreeView;
```

**Step 2: Verify TypeScript compilation**

Run: `cd krillnotes-desktop && npm run build`
Expected: Compiles successfully

**Step 3: Commit**

```bash
git add krillnotes-desktop/src/components/TreeView.tsx
git commit -m "feat(frontend): create TreeView component

Container for rendering tree of notes

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 11: Create InfoPanel Component

**Files:**
- Create: `krillnotes-desktop/src/components/InfoPanel.tsx`

**Step 1: Create InfoPanel component**

Create `krillnotes-desktop/src/components/InfoPanel.tsx`:

```typescript
import type { Note } from '../types';

interface InfoPanelProps {
  selectedNote: Note | null;
}

function InfoPanel({ selectedNote }: InfoPanelProps) {
  if (!selectedNote) {
    return (
      <div className="flex items-center justify-center h-full text-muted-foreground">
        Select a note to view details
      </div>
    );
  }

  const formatTimestamp = (timestamp: number) => {
    return new Date(timestamp * 1000).toLocaleString();
  };

  return (
    <div className="p-6">
      <h1 className="text-4xl font-bold mb-6">{selectedNote.title}</h1>

      <div className="bg-secondary p-6 rounded-lg space-y-4">
        <div>
          <p className="text-sm text-muted-foreground">Type</p>
          <p className="text-lg">{selectedNote.nodeType}</p>
        </div>

        <div>
          <p className="text-sm text-muted-foreground">Created</p>
          <p className="text-sm">{formatTimestamp(selectedNote.createdAt)}</p>
        </div>

        <div>
          <p className="text-sm text-muted-foreground">Modified</p>
          <p className="text-sm">{formatTimestamp(selectedNote.modifiedAt)}</p>
        </div>

        <div>
          <p className="text-sm text-muted-foreground">ID</p>
          <p className="text-xs font-mono">{selectedNote.id}</p>
        </div>
      </div>
    </div>
  );
}

export default InfoPanel;
```

**Step 2: Verify TypeScript compilation**

Run: `cd krillnotes-desktop && npm run build`
Expected: Compiles successfully

**Step 3: Commit**

```bash
git add krillnotes-desktop/src/components/InfoPanel.tsx
git commit -m "feat(frontend): create InfoPanel component

Displays selected note details (title, type, timestamps, ID)

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 12: Create AddNoteDialog Component

**Files:**
- Create: `krillnotes-desktop/src/components/AddNoteDialog.tsx`

**Step 1: Create AddNoteDialog component**

Create `krillnotes-desktop/src/components/AddNoteDialog.tsx`:

```typescript
import { useState, useEffect } from 'react';
import { invoke } from '@tauri-apps/api/core';

interface AddNoteDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onNoteCreated: () => void;
  selectedNoteId: string | null;
  hasNotes: boolean;
}

function AddNoteDialog({ isOpen, onClose, onNoteCreated, selectedNoteId, hasNotes }: AddNoteDialogProps) {
  const [position, setPosition] = useState<'child' | 'sibling'>('child');
  const [nodeType, setNodeType] = useState<string>('');
  const [nodeTypes, setNodeTypes] = useState<string[]>([]);
  const [error, setError] = useState<string>('');
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (isOpen) {
      // Fetch available node types
      invoke<string[]>('get_node_types')
        .then(types => {
          setNodeTypes(types);
          if (types.length > 0) {
            setNodeType(types[0]);
          }
        })
        .catch(err => setError(`Failed to load node types: ${err}`));
    }
  }, [isOpen]);

  if (!isOpen) return null;

  const handleCreate = async () => {
    setLoading(true);
    setError('');

    try {
      await invoke('create_note_with_type', {
        parentId: hasNotes ? selectedNoteId : null,
        position: hasNotes ? position : 'child',
        nodeType
      });
      onNoteCreated();
      onClose();
    } catch (err) {
      setError(`Failed to create note: ${err}`);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div className="bg-background border border-secondary p-6 rounded-lg w-96">
        <h2 className="text-xl font-bold mb-4">
          {hasNotes ? 'Add Note' : 'Creating First Note'}
        </h2>

        {hasNotes && (
          <div className="mb-4">
            <label className="block text-sm font-medium mb-2">Position</label>
            <div className="space-y-2">
              <label className="flex items-center">
                <input
                  type="radio"
                  value="child"
                  checked={position === 'child'}
                  onChange={(e) => setPosition(e.target.value as 'child')}
                  className="mr-2"
                />
                As child of selected note
              </label>
              <label className="flex items-center">
                <input
                  type="radio"
                  value="sibling"
                  checked={position === 'sibling'}
                  onChange={(e) => setPosition(e.target.value as 'sibling')}
                  className="mr-2"
                />
                As sibling of selected note
              </label>
            </div>
          </div>
        )}

        <div className="mb-4">
          <label className="block text-sm font-medium mb-2">Note Type</label>
          <select
            value={nodeType}
            onChange={(e) => setNodeType(e.target.value)}
            className="w-full bg-secondary border border-secondary rounded px-3 py-2"
          >
            {nodeTypes.map(type => (
              <option key={type} value={type}>{type}</option>
            ))}
          </select>
        </div>

        {error && (
          <div className="mb-4 p-3 bg-red-500/10 border border-red-500/20 text-red-500 rounded text-sm">
            {error}
          </div>
        )}

        <div className="flex justify-end gap-2">
          <button
            onClick={onClose}
            className="px-4 py-2 border border-secondary rounded hover:bg-secondary"
            disabled={loading}
          >
            Cancel
          </button>
          <button
            onClick={handleCreate}
            className="px-4 py-2 bg-primary text-primary-foreground rounded hover:bg-primary/90"
            disabled={loading || !nodeType}
          >
            {loading ? 'Creating...' : 'Create'}
          </button>
        </div>
      </div>
    </div>
  );
}

export default AddNoteDialog;
```

**Step 2: Verify TypeScript compilation**

Run: `cd krillnotes-desktop && npm run build`
Expected: Compiles successfully

**Step 3: Commit**

```bash
git add krillnotes-desktop/src/components/AddNoteDialog.tsx
git commit -m "feat(frontend): create AddNoteDialog component

Modal dialog for creating notes with position and type selection

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 13: Create WorkspaceView Component

**Files:**
- Create: `krillnotes-desktop/src/components/WorkspaceView.tsx`

**Step 1: Create WorkspaceView component**

Create `krillnotes-desktop/src/components/WorkspaceView.tsx`:

```typescript
import { useEffect, useState } from 'react';
import { invoke } from '@tauri-apps/api/core';
import { listen } from '@tauri-apps/api/event';
import TreeView from './TreeView';
import InfoPanel from './InfoPanel';
import AddNoteDialog from './AddNoteDialog';
import type { Note, TreeNode, WorkspaceInfo } from '../types';
import { buildTree, findNoteInTree } from '../utils/tree';

interface WorkspaceViewProps {
  workspaceInfo: WorkspaceInfo;
}

function WorkspaceView({ workspaceInfo }: WorkspaceViewProps) {
  const [notes, setNotes] = useState<Note[]>([]);
  const [tree, setTree] = useState<TreeNode[]>([]);
  const [selectedNoteId, setSelectedNoteId] = useState<string | null>(null);
  const [showAddDialog, setShowAddDialog] = useState(false);
  const [error, setError] = useState<string>('');

  // Load notes on mount
  useEffect(() => {
    loadNotes();
  }, []);

  // Set up menu listener
  useEffect(() => {
    const unlisten = listen<string>('menu-action', async (event) => {
      if (event.payload === 'Edit > Add Note clicked') {
        setShowAddDialog(true);
      }
    });

    return () => {
      unlisten.then(f => f());
    };
  }, []);

  const loadNotes = async () => {
    try {
      const fetchedNotes = await invoke<Note[]>('list_notes');
      setNotes(fetchedNotes);

      const builtTree = buildTree(fetchedNotes);
      setTree(builtTree);

      // Set initial selection
      if (workspaceInfo.selectedNoteId) {
        setSelectedNoteId(workspaceInfo.selectedNoteId);
      } else if (builtTree.length > 0) {
        // Auto-select first root node
        const firstRootId = builtTree[0].note.id;
        setSelectedNoteId(firstRootId);
        await invoke('set_selected_note', { noteId: firstRootId });
      }
    } catch (err) {
      setError(`Failed to load notes: ${err}`);
    }
  };

  const handleSelectNote = async (noteId: string) => {
    setSelectedNoteId(noteId);
    try {
      await invoke('set_selected_note', { noteId });
    } catch (err) {
      console.error('Failed to save selection:', err);
    }
  };

  const handleToggleExpand = async (noteId: string) => {
    try {
      await invoke('toggle_note_expansion', { noteId });
      // Reload notes to get updated is_expanded values
      await loadNotes();
    } catch (err) {
      console.error('Failed to toggle expansion:', err);
    }
  };

  const handleNoteCreated = async () => {
    await loadNotes();
  };

  const selectedNote = selectedNoteId
    ? notes.find(n => n.id === selectedNoteId) || null
    : null;

  if (error) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <div className="text-red-500">{error}</div>
      </div>
    );
  }

  return (
    <div className="flex h-screen">
      {/* Left sidebar - Tree */}
      <div className="w-[300px] border-r border-secondary bg-background overflow-hidden">
        <TreeView
          tree={tree}
          selectedNoteId={selectedNoteId}
          onSelect={handleSelectNote}
          onToggleExpand={handleToggleExpand}
        />
      </div>

      {/* Right panel - Info */}
      <div className="flex-1 overflow-y-auto">
        <InfoPanel selectedNote={selectedNote} />
      </div>

      {/* Add Note Dialog */}
      <AddNoteDialog
        isOpen={showAddDialog}
        onClose={() => setShowAddDialog(false)}
        onNoteCreated={handleNoteCreated}
        selectedNoteId={selectedNoteId}
        hasNotes={notes.length > 0}
      />
    </div>
  );
}

export default WorkspaceView;
```

**Step 2: Verify TypeScript compilation**

Run: `cd krillnotes-desktop && npm run build`
Expected: Compiles successfully

**Step 3: Commit**

```bash
git add krillnotes-desktop/src/components/WorkspaceView.tsx
git commit -m "feat(frontend): create WorkspaceView component

Main container with split layout (tree + info panel)
Manages note loading, selection, and expansion state

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 14: Update App.tsx to Use WorkspaceView

**Files:**
- Modify: `krillnotes-desktop/src/App.tsx`

**Step 1: Update imports**

Add import at the top of `krillnotes-desktop/src/App.tsx`:

```typescript
import WorkspaceView from './components/WorkspaceView';
```

**Step 2: Replace WorkspaceInfo with WorkspaceView**

Replace the line in the return statement:

```typescript
// Before:
{workspace ? <WorkspaceInfo info={workspace} /> : <EmptyState />}

// After:
{workspace ? <WorkspaceView workspaceInfo={workspace} /> : <EmptyState />}
```

**Step 3: Remove unused import**

Remove the WorkspaceInfo import (no longer used):

```typescript
// Remove this line:
import WorkspaceInfo from './components/WorkspaceInfo';
```

**Step 4: Verify TypeScript compilation**

Run: `cd krillnotes-desktop && npm run build`
Expected: Compiles successfully

**Step 5: Commit**

```bash
git add krillnotes-desktop/src/App.tsx
git commit -m "feat(frontend): integrate WorkspaceView into App

Replace WorkspaceInfo with new WorkspaceView component

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 15: Manual Integration Testing

**Files:**
- None (testing)

**Step 1: Start development server**

Run: `cd krillnotes-desktop && npm run tauri dev`
Expected: App window opens

**Step 2: Test tree display**

1. Open or create a workspace
2. Verify tree shows in left sidebar (300px wide)
3. Verify root note is displayed
4. Verify info panel shows selected note details on right

**Step 3: Test expand/collapse**

1. Create child note: "Edit > Add Note" â†’ select "As child" â†’ choose type â†’ Create
2. Verify child appears under parent in tree
3. Click collapse button (â–¼) on parent
4. Verify children hide and button changes to â–¶
5. Click expand button (â–¶)
6. Verify children show and button changes to â–¼
7. Close workspace and reopen
8. Verify expansion state persists (still collapsed/expanded as before)

**Step 4: Test selection**

1. Click different notes in tree
2. Verify selection highlights in tree
3. Verify info panel updates with correct note details
4. Verify details show: title, node type, created/modified timestamps, note ID
5. Close workspace and reopen
6. Verify last selected note is still selected

**Step 5: Test add note - child**

1. Select a note
2. "Edit > Add Note" â†’ dialog opens
3. Verify "As child" is selected
4. Select a node type from dropdown
5. Click Create
6. Verify new note appears as child of selected note
7. Verify new note has title "Untitled"

**Step 6: Test add note - sibling**

1. Select a note (that has a parent)
2. "Edit > Add Note" â†’ dialog opens
3. Select "As sibling" radio button
4. Select a node type
5. Click Create
6. Verify new note appears at same level as selected note
7. Verify position ordering is correct

**Step 7: Test add note - empty workspace**

This requires manual database editing or future delete feature.
Skip for now - will test in Phase 4.

**Step 8: Test multi-window state sharing**

1. Open same workspace in two windows
2. In window A: expand a node
3. In window B: refresh or close and reopen
4. Verify window B shows the expansion from window A
5. In each window: select different notes
6. Verify each window tracks its own selection independently

**Step 9: Test error cases**

1. With no workspace open: verify tree view doesn't break
2. With network issues (simulate): verify error messages appear
3. Cancel add note dialog: verify nothing is created

**Step 10: Document test results**

No commit needed - testing complete.

If any issues found, fix them before considering Phase 3 complete.

---

## Summary

**Phase 3 Implementation Complete!** ðŸŽ‰

**Delivered:**
- âœ… Database schema with is_expanded column and migrations
- âœ… Backend commands: get_node_types, toggle_note_expansion, set_selected_note, create_note_with_type
- âœ… Frontend tree building utility
- âœ… Five new React components: TreeNode, TreeView, InfoPanel, AddNoteDialog, WorkspaceView
- âœ… Split view layout (tree + info panel)
- âœ… State persistence in SQLite database
- âœ… Add note dialog with position and type selection
- âœ… Manual integration testing

**Tasks Completed:** 15

**Next Phase:** Phase 4 (Detail View & Editing) - edit note titles and fields, delete notes
