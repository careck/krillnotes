# Sync Gate Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Gate the operations log behind `Option<OperationLog>` so no writes happen when sync is off, grey out the Operations Log menu item permanently for now, and add a placeholder Sync tab to the Settings dialog.

**Architecture:** `Workspace.operation_log` becomes `Option<OperationLog>` â€” `None` means sync off, no logging. Two private helper methods (`log_op` / `purge_ops_if_needed`) keep all ~25 call sites as single-line changes. The menu item is removed from `workspace_items` so it never auto-enables. The Settings dialog gains a tabbed layout with a locked Sync toggle.

**Tech Stack:** Rust (rusqlite, serde), Tauri v2, React/TypeScript, Tailwind CSS

---

### Task 1: Make `operation_log` optional in `Workspace`

**Files:**
- Modify: `krillnotes-core/src/core/workspace.rs`

**Step 1: Write a failing test**

Find the existing workspace tests (search for `#[cfg(test)]` at the bottom of `workspace.rs`). Add this test inside the `tests` module:

```rust
#[test]
fn operations_log_empty_when_sync_off() {
    let dir = tempdir().unwrap();
    let mut ws = Workspace::create(
        dir.path().join("test.krillnotes"),
        "Test",
        None,
        "device-test",
        1,
    ).unwrap();
    ws.create_note(None, "folder", "My Note", 1).unwrap();
    let ops = ws.list_operations(None, None, None).unwrap();
    assert!(ops.is_empty(), "expected no operations when sync is off");
}
```

**Step 2: Run the test to verify it fails**

```bash
cargo test -p krillnotes-core operations_log_empty_when_sync_off
```

Expected: **FAIL** â€” test compiles but `ops` is not empty (logging still active).

**Step 3: Change the field type**

In `workspace.rs`, change line 44:

```rust
// Before
operation_log: OperationLog,

// After
operation_log: Option<OperationLog>,
```

**Step 4: Update `create()` â€” pass `None`**

Around line 60, change:

```rust
// Before
let operation_log = OperationLog::new(PurgeStrategy::LocalOnly { keep_last: 1000 });

// After
let operation_log: Option<OperationLog> = None;
```

**Step 5: Update `open()` â€” pass `None`**

Around line 182, apply the same change:

```rust
// Before
let operation_log = OperationLog::new(PurgeStrategy::LocalOnly { keep_last: 1000 });

// After
let operation_log: Option<OperationLog> = None;
```

**Step 6: Add private helper methods**

After the `impl Workspace {` opening (or near the other private helpers), add:

```rust
fn log_op(&self, tx: &rusqlite::Transaction, op: &Operation) -> Result<()> {
    if let Some(log) = &self.operation_log {
        log.log(tx, op)?;
    }
    Ok(())
}

fn purge_ops_if_needed(&self, tx: &rusqlite::Transaction) -> Result<()> {
    if let Some(log) = &self.operation_log {
        log.purge_if_needed(tx)?;
    }
    Ok(())
}
```

**Step 7: Replace all `self.operation_log.log(` call sites**

There are ~15 occurrences. Do a find-and-replace across the file:

- `self.operation_log.log(&tx, &op)?;`  â†’  `self.log_op(&tx, &op)?;`
- `self.operation_log.log(&tx, &title_op)?;`  â†’  `self.log_op(&tx, &title_op)?;`
- `self.operation_log.log(&tx, &field_op)?;`  â†’  `self.log_op(&tx, &field_op)?;`

**Step 8: Replace all `self.operation_log.purge_if_needed(` call sites**

- `self.operation_log.purge_if_needed(&tx)?;`  â†’  `self.purge_ops_if_needed(&tx)?;`

**Step 9: Update `list_operations` and `purge_all_operations`**

Around lines 2063 and 2068:

```rust
// Before
pub fn list_operations(&self, ...) -> Result<Vec<OperationSummary>> {
    self.operation_log.list(self.connection(), type_filter, since, until)
}

pub fn purge_all_operations(&mut self) -> Result<usize> {
    self.operation_log.purge_all(self.connection())
}

// After
pub fn list_operations(&self, ...) -> Result<Vec<OperationSummary>> {
    match &self.operation_log {
        Some(log) => log.list(self.connection(), type_filter, since, until),
        None => Ok(vec![]),
    }
}

pub fn purge_all_operations(&mut self) -> Result<usize> {
    match &self.operation_log {
        Some(log) => log.purge_all(self.connection()),
        None => Ok(0),
    }
}
```

**Step 10: Run the test to verify it passes**

```bash
cargo test -p krillnotes-core operations_log_empty_when_sync_off
```

Expected: **PASS**

**Step 11: Run the full test suite**

```bash
cargo test -p krillnotes-core
```

Expected: all existing tests still pass. Fix any compile errors before continuing.

**Step 12: Commit**

```bash
git add krillnotes-core/src/core/workspace.rs
git commit -m "feat: make operation_log optional â€” None when sync is off (issue #48)"
```

---

### Task 2: Remove Operations Log from workspace_items in the menu

**Files:**
- Modify: `krillnotes-desktop/src-tauri/src/menu.rs:104-107`

**Step 1: Remove `operations_log` from `workspace_items`**

Line 106 â€” change:

```rust
// Before
workspace_items: vec![manage_scripts, operations_log],

// After
workspace_items: vec![manage_scripts],
```

The `operations_log` variable still exists and is still added to the submenu (line 101), so the menu item remains visible but permanently disabled. It just won't be auto-enabled when a workspace opens.

**Step 2: Build to confirm no compile errors**

```bash
cargo build -p krillnotes-desktop
```

Expected: **success**. If `operations_log` is flagged as unused, that's fine â€” it's still referenced on line 101 in `.items(&[&manage_scripts, &operations_log])`.

**Step 3: Commit**

```bash
git add krillnotes-desktop/src-tauri/src/menu.rs
git commit -m "feat: keep Operations Log menu item permanently greyed out (issue #48)"
```

---

### Task 3: Add Sync tab to SettingsDialog

**Files:**
- Modify: `krillnotes-desktop/src/components/SettingsDialog.tsx`

**Step 1: Add tab state**

After the existing `useState` declarations (around line 24), add:

```tsx
const [activeTab, setActiveTab] = useState<'general' | 'sync'>('general');
```

**Step 2: Restructure the dialog to have a tab bar**

Replace the `<h2>` title block (line 98) and the opening of the form with a tab bar + conditional content. The full restructured JSX for the dialog body (inside the `<div className="bg-background ...">`) should look like:

```tsx
<h2 className="text-xl font-bold mb-4">{t('settings.title')}</h2>

{/* Tab bar */}
<div className="flex border-b border-border mb-4">
  <button
    onClick={() => setActiveTab('general')}
    className={`px-4 py-2 text-sm font-medium border-b-2 -mb-px ${
      activeTab === 'general'
        ? 'border-primary text-foreground'
        : 'border-transparent text-muted-foreground hover:text-foreground'
    }`}
  >
    {t('settings.tabGeneral')}
  </button>
  <button
    onClick={() => setActiveTab('sync')}
    className={`px-4 py-2 text-sm font-medium border-b-2 -mb-px ${
      activeTab === 'sync'
        ? 'border-primary text-foreground'
        : 'border-transparent text-muted-foreground hover:text-foreground'
    }`}
  >
    {t('settings.tabSync')}
  </button>
</div>

{/* General tab */}
{activeTab === 'general' && (
  <>
    {/* ... existing settings content (workspace dir, passwords, appearance) ... */}
  </>
)}

{/* Sync tab */}
{activeTab === 'sync' && (
  <div className="py-2">
    <label className="flex items-center gap-3 opacity-50 cursor-not-allowed">
      <input
        type="checkbox"
        checked={false}
        disabled
        className="w-4 h-4"
      />
      <div>
        <span className="block text-sm font-medium">{t('settings.sync')}</span>
        <span className="block text-xs text-muted-foreground mt-0.5">
          {t('settings.syncHint')}
        </span>
      </div>
    </label>
  </div>
)}
```

Wrap the existing settings content (lines 100â€“221) inside the `{activeTab === 'general' && (...)}` block without changing any of it.

**Step 3: Add i18n keys**

The app uses `react-i18next`. Translation files are in `krillnotes-desktop/src/i18n/`. Add the following keys to **every language file** (`en.json`, `de.json`, `fr.json`, `es.json`, `ja.json`, `ko.json`, `zh.json`):

Find each file and add to the `settings` object:

```json
"tabGeneral": "General",
"tabSync": "Sync",
"sync": "Sync",
"syncHint": "Sync keeps your notes up to date across devices. Coming soon."
```

For non-English files, you can use the English strings as placeholders â€” they'll be localised properly when sync ships.

**Step 4: Build the frontend**

```bash
cd krillnotes-desktop && npm run build
```

Expected: **success**, no TypeScript errors.

**Step 5: Commit**

```bash
git add krillnotes-desktop/src/components/SettingsDialog.tsx
git add krillnotes-desktop/src/i18n/
git commit -m "feat: add locked Sync tab to Settings dialog (issue #48)"
```

---

### Task 4: End-to-end smoke test + final commit

**Step 1: Run the Tauri app locally**

```bash
cd krillnotes-desktop && cargo tauri dev
```

Verify manually:
- [ ] Open a workspace â†’ "Operations Log..." in the Tools menu stays greyed out
- [ ] Open Settings â†’ two tabs appear: "General" and "Sync"
- [ ] Sync tab shows a disabled, unchecked toggle with the "Coming soon" hint
- [ ] General tab still works exactly as before

**Step 2: Run all tests one final time**

```bash
cargo test -p krillnotes-core
```

Expected: all tests pass.

**Step 3: Push and open PR**

```bash
git push -u github-https feat/sync-gate
gh pr create \
  --title "feat: gate operations log behind sync flag (issue #48)" \
  --body "Closes #48

## Summary
- \`Workspace.operation_log\` is now \`Option<OperationLog>\` â€” always \`None\` while sync is not implemented, so no writes to the operations table
- Operations Log menu item removed from \`workspace_items\`, so it stays permanently greyed out
- Settings dialog gains a Sync tab with a disabled toggle and 'Coming soon' hint

## Test plan
- [ ] Open workspace, create/edit/delete notes â€” no rows in operations table
- [ ] Tools > Operations Log... is greyed out with workspace open
- [ ] Settings > Sync tab visible, toggle disabled, hint text shown
- [ ] Settings > General tab unchanged and still saves correctly
- [ ] All Rust tests pass

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)" \
  --base master
```
