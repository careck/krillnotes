# i18n Design — Internationalisation (Issue #43)

**Date:** 2026-02-28
**Status:** Approved

## Summary

Add UI translation (language packs), locale-aware date/number formatting, and document UTF-8 support for Krillnotes. Language packs are built-in (no external fetching). The implementation uses `react-i18next` + `i18next` as the translation layer.

## Scope

| Concern | In scope | Approach |
|---|---|---|
| UI translation | ✅ | react-i18next with bundled JSON packs |
| Locale-aware dates/numbers | ✅ | `Intl.*` APIs driven by `i18next.language` |
| UTF-8 input/storage | ✅ (verified) | No code changes — already handled by SQLite + WKWebView |
| Importable community packs | ❌ | Out of scope for now |

## Languages

7 bundled languages; English is always the fallback:

| Code | Label |
|---|---|
| `en` | English |
| `de` | Deutsch |
| `fr` | Français |
| `es` | Español |
| `ja` | 日本語 |
| `ko` | 한국어 |
| `zh` | 中文 (Simplified) |

## Section 1 — Translation Infrastructure

**Library:** `i18next` + `react-i18next` (~50 KB combined).

**Locale files:** Static TypeScript/JSON imports, bundled at build time. No runtime fetching, no loading states, no flash of untranslated content.

```
src/i18n/
  index.ts           ← i18next init; imports all locale files
  locales/
    en.json          ← source of truth
    de.json
    fr.json
    es.json
    ja.json
    ko.json
    zh.json
```

**Init pattern** (`src/i18n/index.ts`):
```ts
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import en from './locales/en.json';
import de from './locales/de.json';
// …

i18n.use(initReactI18next).init({
  resources: { en: { translation: en }, de: { translation: de }, /* … */ },
  lng: 'en',          // overridden at startup from settings
  fallbackLng: 'en',
  interpolation: { escapeValue: false }, // React escapes by default
});

export default i18n;
```

i18next is initialised synchronously before React renders (imported in `main.tsx` before `ReactDOM.createRoot`).

**Usage in components:**
```tsx
const { t } = useTranslation();
// …
<button>{t('common.save')}</button>
<p>{t('settings.workspaceDirHint')}</p>
<p>{t('dialogs.import.success', { noteCount: 42, scriptCount: 3 })}</p>
```

## Section 2 — Persistence

**Rust (`src-tauri/src/settings.rs`):** Add one field, following the existing `active_theme_mode` pattern:

```rust
#[serde(default = "default_language")]
pub language: String,

fn default_language() -> String { "en".to_string() }
```

`#[serde(default)]` ensures old settings files without the field parse cleanly and default to English.

**TypeScript (`src/types.ts`):** Add `language?: string` to `AppSettings`.

**Startup flow:**
1. `App.tsx` already calls `get_settings` on mount.
2. After loading settings, call `i18n.changeLanguage(settings.language ?? 'en')`.
3. The whole UI re-renders reactively via react-i18next's bindings.

**On language change in Settings:**
- Call `i18n.changeLanguage(newLang)` immediately for live preview while the dialog is open.
- On Save, persist via `update_settings` as part of the normal settings save.
- On Cancel, call `i18n.changeLanguage(originalLang)` to revert.

## Section 3 — Settings UI

Add a "Language" row to the Appearance section of `SettingsDialog.tsx`, above the Mode toggle:

```
Language    [English          ▼]
Mode        [light] [dark] [system]
Light theme [light (built-in) ▼]
Dark theme  [dark (built-in)  ▼]
            Manage Themes…
```

Language labels in the dropdown use the language's own name (e.g. "Deutsch", not "German") so non-English speakers can find their language regardless of the current UI language.

## Section 4 — Translation Key Structure

~200 raw strings collapse to ~120 unique keys once common labels (Save, Cancel, Delete, etc.) are shared via `common.*`.

```
common.*
  save, saving, cancel, close, delete, edit, replace, confirm,
  back, browse, import, importing, create, creating, open,
  encrypt, next, view, add, yes, no

settings.*
  title, workspaceDir, workspaceDirHint, rememberPasswords,
  rememberPasswordsHint, appearance, mode, language,
  lightTheme, darkTheme, manageThemes, failedLoad, failedSave

themes.*
  manage, newTheme, builtIn, editing, invalidJson, deleteConfirm,
  builtInReadOnly, conflictWarning, failedRead, failedDelete,
  failedImport, setLight, setDark, activeLight, activeDark,
  importFromFile, newThemeButton

scripts.*
  title, editing, newScript, addButton, importFromFile,
  noScripts, disableScript, enableScript, unnamed,
  deleteWarning, replaceConfirm, conflictWarning,
  failedLoad, failedToggle, failedDelete, failedImport,
  reloadErrors

workspace.*
  openTitle, newTitle, noWorkspaces, alreadyOpen,
  namePlaceholder, nameRequired, nameInvalid, savedTo,
  propertiesTitle, propertiesHint, failedList, noTagsYet,
  failedLoad, treeActionFailed, exportSuccess, exportFailed,
  importSuccess, importFailed, versionMismatch

notes.*
  addRoot, addChild, addSibling, noteType, noAllowedTypes,
  noNotes, failedCreate, copyNote, pasteAsChild, pasteAsSibling,
  fields, legacyFields, noFields, info, type, created, modified, id,
  discardChanges

dialogs.password.*
  setTitle, enterTitle, passwordLabel, confirmLabel,
  passwordPlaceholder, confirmPlaceholder, repeatPlaceholder,
  wrongPassword, mismatch, required, legacyWorkspace,
  protectPrompt, protectHint, optionalPlaceholder,
  skipNoEncryption, archiveProtected, archiveHint

dialogs.import.*
  title, workspaceName, importing, versionMismatch

fields.*
  notRated, unknown, notSet, yesLabel, noLabel, clearLink,
  noOptions, selectPlaceholder, linkedNote, searchPlaceholder

tags.*
  addPlaceholder, remove

search.*
  placeholder, noResults

log.*
  title, allTypes, from, to, noOperations, dateTime,
  target, type, count, count_one, deleteAll, purgeAll

empty.*
  getStarted
```

**Pluralisation example** (i18next `_one` / `_other` convention):
```json
"log": {
  "count_one": "{{count}} operation",
  "count_other": "{{count}} operations"
}
```

## Section 5 — Locale-aware Formatting

**Dates** (`FieldDisplay.tsx`):
```ts
// Before: uses OS locale (ignores app language setting)
new Date(...).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })

// After: uses app language
import i18n from '../i18n';
new Date(...).toLocaleDateString(i18n.language, { year: 'numeric', month: 'long', day: 'numeric' })
// de → "28. Februar 2026"   ja → "2026年2月28日"   ko → "2026년 2월 28일"
```

**Numbers** (also `FieldDisplay.tsx`, plain number fields):
```ts
// Before
<p>{value.Number}</p>

// After
<p>{value.Number.toLocaleString(i18n.language)}</p>
// de → "1.234,5"   en → "1,234.5"
```

## Section 6 — UTF-8

SQLite stores text as UTF-8 natively. Tauri's WKWebView (macOS) and WebView2 (Windows) handle all Unicode. Standard HTML `<input>` and `<textarea>` elements accept any Unicode input. No code changes are required.

**QA checklist item:** Manually paste CJK and Arabic characters into a text field, save, close, and reopen the workspace to confirm round-trip integrity.

## Files Touched

### New files
- `krillnotes-desktop/src/i18n/index.ts`
- `krillnotes-desktop/src/i18n/locales/en.json`
- `krillnotes-desktop/src/i18n/locales/de.json`
- `krillnotes-desktop/src/i18n/locales/fr.json`
- `krillnotes-desktop/src/i18n/locales/es.json`
- `krillnotes-desktop/src/i18n/locales/ja.json`
- `krillnotes-desktop/src/i18n/locales/ko.json`
- `krillnotes-desktop/src/i18n/locales/zh.json`

### Modified files
- `krillnotes-desktop/package.json` — add `i18next`, `react-i18next`
- `krillnotes-desktop/src/main.tsx` — import `./i18n` before React renders
- `krillnotes-desktop/src/types.ts` — `language?: string` on `AppSettings`
- `krillnotes-desktop/src-tauri/src/settings.rs` — `language` field + default
- `krillnotes-desktop/src/App.tsx` — call `i18n.changeLanguage` on settings load
- `krillnotes-desktop/src/components/SettingsDialog.tsx` — language dropdown, live preview + revert on cancel
- `krillnotes-desktop/src/components/FieldDisplay.tsx` — locale-aware date + number formatting
- `krillnotes-desktop/src/components/` (all 21 other component files) — replace hardcoded strings with `t('key')`

## Decisions

- **No language auto-detect** — language is explicitly chosen in Settings. Users who want their OS language can set it manually once.
- **Single namespace** — one `translation` namespace is sufficient for this app's size.
- **Static imports** — no dynamic chunk loading; all locale JSON is bundled. Adds ~30 KB gzipped to the bundle (acceptable for a desktop app).
- **Live preview** — `i18n.changeLanguage()` fires immediately on dropdown change; reverted on Cancel.
- **Fallback** — any key missing from a translation silently falls back to English; no crashes, no blank labels.
